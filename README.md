Chaco Central
================

Personal portfolio + technical blog served by Nginx behind Cloudflare Tunnel. Static content is generated by Hugo.

Stack
-----
- Hugo for content (builds into `site/public/`)
- Nginx (alpine) serving static files on `8081` inside the container
- Cloudflare Tunnel (no host ports exposed)
- Docker Compose on a dedicated bridge network `web_pub`

Security
--------
- `read_only` root FS on both containers
- `no-new-privileges` enabled
- `cap_drop: [ALL]`
- `tmpfs` mounted for runtime/cache paths

Repo Layout
-----------
- `docker-compose.yml`: services and network
- `docker/nginx/nginx.conf`: hardened Nginx config (listens on 8080)
- `site/public/`: Hugo output directory (served by Nginx)
- `.env.example`: sample env; copy to `.env` and set your token
- `.gitignore`: excludes `.env` and `site/public/`

Quick Start
-----------
1) Create/confirm Cloudflare Tunnel + Hostname
   - In Cloudflare Zero Trust, create a Named Tunnel.
   - Add a Public Hostname, e.g. `www.chaco.dev`.
   - Service target: `http://web:8081` (Docker service name + internal port).

2) Set the Tunnel token
   - Copy `.env.example` to `.env` and paste your `TUNNEL_TOKEN` from the Cloudflare UI (Docker connection snippet).

3) Build Hugo content
   - Generate your site locally with Hugo, outputting to `site/public/`.
   - For now, a placeholder `index.html` is present so you can test the stack.

   Hugo Modules (theme):
   - From `site/`, initialize and fetch the theme once:
     - `hugo mod init chaco-central`
     - `hugo mod get github.com/gurusabarish/hugo-profile`

4) Bring up the stack (builds first, then starts)
   - `UID=$(id -u) GID=$(id -g) docker compose up -d`
   - Compose runs the one-shot `hugo` build, then starts Nginx (`web`) and `cloudflared`.

Local Development Workflow
--------------------------
- Edit content in `site/`.
- Rebuild + restart in one step:
  - `UID=$(id -u) GID=$(id -g) docker compose up -d`
  - This rebuilds with `hugo` and then starts the containers.

One-Command Recreate (server)
----------------------------
- Pull latest, rebuild, and start cleanly:
  - `docker compose down && UID=$(id -u) GID=$(id -g) docker compose up -d`
  - This ensures the Hugo build runs before Nginx starts.

Optional: Build only (no restart)
---------------------------------
- Rebuild the static files without touching other containers:
  - `UID=$(id -u) GID=$(id -g) docker compose run --rm hugo`
  - `docker restart chaco_web`

Notes
-----
- Nginx runs unprivileged on 8081 so we can drop all capabilities.
- TLS is handled by Cloudflare; Nginx serves plain HTTP in the internal network.
- Ensure your Cloudflare DNS record for the hostname is `Proxied` and bound to the tunnel.
- 8080 already in use? This stack listens on 8081 internally (no host port exposed), so it won’t conflict with other services.

Compose Behavior
----------------
- `web` declares `depends_on` the one-shot `hugo` service with condition `service_completed_successfully`.
- `docker compose up -d` will build the site and then start Nginx and Cloudflared.
- Simple container restarts do not rebuild; use `up -d` when you want a rebuild.

Canonical URL
-------------
- Set the Hugo base URL to the public hostname:
  - In `site/hugo.toml`: `baseURL = "https://www.chaco.dev/"`
- Optional apex redirect (Cloudflare zone `chaco.dev`):
  - DNS: add proxied A record for `@` → `192.0.2.1`
  - Rules → Redirect Rules: wildcard `https://chaco.dev/*` → `https://www.chaco.dev/${1}` with 301 and preserve query string

Next Content To-Dos
-------------------
- About/Resume page with external links (GitHub, LinkedIn)
- Projects landing page with flagship posts (e.g., ZFS, Pi-hole, Cloudflare Tunnel, OPNsense)
- Certifications section (Security+, Network+, A+)
- Blog and Changelog/Build Notes
